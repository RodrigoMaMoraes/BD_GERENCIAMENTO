# BD_GERENCIAMENTO

CREATE TABLE CLIENTES (
    ID INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    NOME VARCHAR(123),
    EMAIL VARCHAR(123),
    TELEFONE VARCHAR(123),
    ENDERECO VARCHAR(123)
);

INSERT INTO CLIENTES (NOME, EMAIL, TELEFONE, ENDERECO) VALUES ('PEDRO', 'PEDRO@GMAIL.COM', '123123', 'RUA DA CRUZ'),
    ('TIAGO', 'JOAO@GMAIL.COM', '321321', 'RUA BARCO AFUNDADO'),
    ('JHON', 'JHON@GMAIL.COM', '777999', 'RUA SOBRE AS AGUAS');

CREATE TABLE PEDIDOS (
    ID INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    DATA_PEDIDO DATE,
    VALOR DECIMAL(10,2),
    CLIENTE_ID INT,
    FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTES(ID)
);

INSERT INTO PEDIDOS (DATA_PEDIDO, VALOR, CLIENTE_ID) VALUES ('2022-10-10', 50.50, 1),
    ('2023-12-12', 50.50, 2),
    ('2024-11-11', 50.50, 3);

DELIMITER $$

CREATE PROCEDURE INSEPEDIDO(
    IN CLIENTE_ID INT,
    IN DATA_PEDIDO DATE,
    IN VALOR DECIMAL(10,2)
)
BEGIN
    INSERT INTO PEDIDOS(CLIENTE_ID, DATA_PEDIDO, VALOR) VALUES (CLIENTE_ID, DATA_PEDIDO, VALOR);
END$$

DELIMITER ;

CALL INSEPEDIDO(5, '2024-05-05', 120.00);

SELECT * FROM PEDIDOS;

ALTER TABLE CLIENTES ADD TOTALPEDIDOS DECIMAL(10, 2);

DELIMITER $$
CREATE TRIGGER ATUALIZATOTALPEDIDOS 
AFTER INSERT ON PEDIDOS
FOR EACH ROW
BEGIN
    UPDATE CLIENTES
    SET TOTALPEDIDOS = TOTALPEDIDOS + NEW.VALOR
    WHERE ID = NEW.CLIENTE_ID;
END$$
DELIMITER ;

INSERT INTO PEDIDOS (CLIENTE_ID, DATA_PEDIDO, VALOR)
VALUES (2, '2021-03-12', 80.00);

SELECT * FROM CLIENTES;

CREATE VIEW PEDIDOSCLIENTES AS
SELECT 
    CLIENTES.NOME, 
    PEDIDOS.VALOR, 
    PEDIDOS.DATA_PEDIDO, 
    PEDIDOS.CLIENTE_ID
FROM CLIENTES
INNER JOIN PEDIDOS
ON CLIENTES.ID = PEDIDOS.CLIENTE_ID;

SELECT * FROM CLIENTES INNER JOIN PEDIDOSCLIENTES ON CLIENTES.ID = PEDIDOSCLIENTES.CLIENTE_ID;
